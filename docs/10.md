# 10. 목 객체 사용

## 테스트 도전 과제

- iloveyouboss_mock-1/src/iloveyouboss/AddressRetriever.java
- iloveyouboss 애플리케이션에 새로운 기능으로 주소를 입력하는 대신 지도에서 Profile 주소를 나타내는 지점을 선택하게 한다.
- 이번에 할 일은  `AddressRetriever 클래스의 retrieve() 메서드`에 관한 테스트를 작성하는 것이다.

```java
public Address retrieve(double latitude, double longitude)
         throws IOException, ParseException {
    // ...
    String response = new HttpImpl().get(
    "http://open.mapquestapi.com/nominatim/v1/reverse?format=json&"
    + parms);
    // ...
}
```

- `HttpImpl 클래스`는 아파치의 HttpComponents 클라이언트와 상호작용하여 REST 호출을 한다.
- HttpImple 클래스는 Http 인터페이스를 구현한다.

```java
public interface Http {
   String get(String url) throws IOException;
}
```

- HttpImple 클래스는 `HTTP상의 외부 서비스와 상호 작용`해야 한다. 이는 단위 테스트가 어려워지게 만든다.
  - 실체 호출에 대한 테스트는 나머지 대다수의 빠른 테스트들에 비해 속도가 느릴 것이다.
  - Nominatim HTTP API가 항상 이용할 수 있는지 보장할 수 없다.
- 의존이 있는 다른 코드와 분리하여 retrieve() 메서드의 로직에 관한 단위 테스트를 하고 싶다.
- HttpImpl 클래스를 신뢰할 수 있다면 다음을 테스트하면 된다.
  -  HTTP 호출을 준비하는 로직
  -  그 호출에 대한 HTTP 응답에서 생성되는 Address 객체를 생성하는 로직

## 번거로운 동작을 스텁으로 대체

- 먼저 HTTP 호출에서 반환되는 JSON 응답을 이용하여 Address 객체를 생성하는 로직을 검증하는 데 집중한다.
  - 그렇게 하려면 `HttpImple 클래스의 get() 메서드 동작을 변경`할 필요가 있다.
- 일단 테스트를 작성하는 용도로 `하드 코딩한 JSON 문자열을 반환`하도록 한다.
- `테스트 용도로 하드 코딩한 값을 반환하는 구현체`를 `스텁(stub)`이라고 한다.

```java
Http http = (String url) -> 
    "{\"address\":{"
    + "\"house_number\":\"324\","
    + "\"road\":\"North Tejon Street\","
    + "\"city\":\"Colorado Springs\","
    + "\"state\":\"Colorado\","
    + "\"postcode\":\"80903\","
    + "\"country_code\":\"us\"}"
    + "}";
```

- HttpImpl 클래스에 있는 프로덕션 구현 대신에 스텁을 사용하려면 AddressRetriever 클래스에 전달해야 한다.
  - `의존성 주입(dependency injection) 기법`을 활용한다.
  - 이번에는 생성자를 이용한 주입을 사용한다.

```java
public class AddressRetriever {
   private Http http;

   public AddressRetriever(Http http) {
      this.http = http;
   }

    public Address retrieve(double latitude, double longitude)
         throws IOException, ParseException {
        // ...
        String response = http.get(
            "http://open.mapquestapi.com/nominatim/v1/reverse?format=json&"
            + parms);
        // ...
   }
}
```


---
[Home](../README.md)
