# 13. 까다로운 테스트

## 멀티스레드 코드 테스트

- 동작하는 `동시성(concurrent) 코드`를 작성하는 것은 어렵다.
  - 동시성이 필요한 애플레케이션 코드를 테스트하는 것은 `기술적 단위 테스트 영역이 아니다`.
  - `통합 테스트(integration testing)로 분류`하는 것이 낫다.
- 스레드를 사용하는 코드에 대한 테스트는 느린 경향이 있다.
  - 스레드에 관한 결함은 한참 후에 등장하기도 한다.

### 단순하고 똑똑하게 유지

- 멀티스레드 코드를 테스트할 때는 다음 주요 주제를 따른다.
  - 스레드 통제와 애플리케이션 코드 사이의 중첩을 최소화한다.
    - 최대한 스레드 없이 단위 테스트를 할 수 있게 설계를 변경한다.
  - 다른 사람의 작업을 믿는다.
    - 자바 5에 Doug Lea가 만든 동시성 유틸리티는 충분히 검증 받았다.
    - 생산자/소비자 문제는 BlockingQueue 클래스를 사용하자.

### 모든 매칭 찾기

- ProfileMatcher 클래스는 모든 관련 프로파일을 수집한다.
- 클라이언트에서 주어진 조건 집합에서 ProfileMatcher 인스턴스는 프로파일을 순회하여 조건에 맞는 결과를 MatchSet 인스턴스와 함께 반환한다.
- iloveyouboss_thread-1/src/iloveyouboss/ProfileMatcher.java

### 애플리케이션 로직 추출

- findMatchingProfiles() 메서드는 애플리케이션 로직과 스레드 로직을 둘 다 사용한다.
- 첫 번째 과제는 이를 분리하는 것이다.

```java
public void findMatchingProfiles(
  Criteria criteria, MatchListener listener) {
  ExecutorService executor = 
        Executors.newFixedThreadPool(DEFAULT_POOL_SIZE);

  for (MatchSet set: collectMatchSets(criteria)) {
      Runnable runnable = () -> {
        if (set.matches())
            listener.foundMatch(profiles.get(set.getProfileId()), set);
      };
      executor.execute(runnable);
  }
  executor.shutdown();
}

List<MatchSet> collectMatchSets(Criteria criteria) {
  List<MatchSet> matchSets = profiles.values().stream()
    .map(profile -> profile.getMatchSet(criteria)) 
    .collect(Collectors.toList());
  return matchSets;
}
```

- collectMatchSets() 메서드에 대한 테스트는 다음 파일에서 확인 가능하다.
  - iloveyouboss_thread-2/test/iloveyouboss/ProfileMatcherTest.java
- 이제 유사하게 프로파일 정보를 리스너(listener)로 넘기는 로직도 추출한다.

```java
public void findMatchingProfiles(
  Criteria criteria, MatchListener listener) {
  ExecutorService executor = 
        Executors.newFixedThreadPool(DEFAULT_POOL_SIZE);

  for (MatchSet set: collectMatchSets(criteria)) {
      Runnable runnable = () -> process(listener, set);
      executor.execute(runnable);
  }
  executor.shutdown();
}

void process(MatchListener listener, MatchSet set) {
  if (set.matches())
      listener.foundMatch(profiles.get(set.getProfileId()), set);
}

// ...
```

- process() 메서드에 대한 테스트를 작성한다.

```java
public class ProfileMatcherTest {
  // ...
  private MatchListener listener;

  @Before
  public void createMatchListener() {
    listener = mock(MatchListener.class); // (1)
  }

  @Test
  public void processNotifiesListenerOnMatch() {
    matcher.add(matchingProfile);  // (2)
    MatchSet set = matchingProfile.getMatchSet(criteria); // (3)

    matcher.process(listener, set); // (4)
    
    verify(listener).foundMatch(matchingProfile, set); // (5)
  }

  @Test
  public void processDoesNotNotifyListenerWhenNoMatch() {
    matcher.add(nonMatchingProfile);
    MatchSet set = nonMatchingProfile.getMatchSet(criteria);

    matcher.process(listener, set);
    
    verify(listener, never()).foundMatch(nonMatchingProfile, set);
  }
  // ...
}
```

- 테스트는 모키토가 기대하는 사항을 검증하는 기능을 활용한다.
- 기대한 인수로 메서드가 호출됐는지 검증한다.
- `(5)`는 모키토를 활용하여 목으로 만든 리스너 객체의 foundMatch() 메서드가 호출됐는지 확인한다.

### 스레드 로직의 테스트 지원을 위해 재설계

- 이제 findMatchingProfiles() 메서드에 있는 코드는 대부분 스레드 로직이다.
- 테스트를 위해 약간 재작업은 코드는 아래와 같다.
  - iloveyouboss_thread-4/src-iloveyouboss/ProfileMatcher.java
- 테스트 코드에서 ExecutorService 인스턴스에 접근할 필요가 있다. (excutor)
  - 따라서 초기화를 필드로 추출하고 Getter 메서드를 제공한다.
- process() 메서드는 이미 테스트했으므로 안전하다.
  - 따라서 findMatchingProfiles() 메서드를 테스트할 떄는 로직을 무시한다.
  - 그리고 findMatchingProfiles() 메서드를 오버로드하여 동작을 스텁 처리한다.

### 스레드 로직을 위한 테스트 작성

- 코드는 이전과 똑같이 동작해야 하지만 쉽게 테스트할 수 있도록 몇 가지를 설정한다.

```java
public class ProfileMatcherTest {
  // ...
  @Test
  public void gathersMatchingProfiles() {
    Set<String> processedSets = 
          Collections.synchronizedSet(new HashSet<>()); // (1)
    BiConsumer<MatchListener, MatchSet> processFunction = 
          (listener, set) -> { // (2)
        processedSets.add(set.getProfileId()); // (3)
    };
    List<MatchSet> matchSets = createMatchSets(100); // (4)

    matcher.findMatchingProfiles( // (5)
          criteria, listener, matchSets, processFunction); 
    
    while (!matcher.getExecutor().isTerminated()) // (6)
        ;
    assertThat(processedSets, equalTo(matchSets.stream()
        .map(MatchSet::getProfileId).collect(Collectors.toSet()))); // (7)
  }

  private List<MatchSet> createMatchSets(int count) {
    List<MatchSet> sets = new ArrayList<>();
    for (int i = 0; i < count; i++)
        sets.add(new MatchSet(String.valueOf(i), null, null));
    return sets;
  }
}
```

- 애플리케이션 로직과 스레드 로직의 관심사를 분리하여 테스트를 작성하였다.
- 스레드 중심 테스트를 처리하는 데 도움이 되는 유틸리티 메서드를 만들면서 스레드 관련 테스트도 쉬워졌다.


---
[Home](../README.md)
