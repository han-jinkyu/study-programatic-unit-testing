# 8. 깔끔한 코드로 리팩토링하기

## 작은 리팩토링

- 코드를 리팩토링한다는 것은 기존 기능은 그대로 유지하면서 코드의 하부 구조를 건강하게 변형하는 것이다.
- 하지만 마음대로 코드 구조를 바꾸는 것은 위험하다.
- 이럴 때 적절한 보호 장치가 있는지 확인할 필요가 있는데 그것이 바로 `테스트`다.

### 리팩토링의 기회

- iloveyouboss_16/src/iloveyouboss/Profile.java

### 메서드 추출: 두 번째로 중요한 리팩토링 친구

- 리팩토링의 가장 중요한 요소는 `이름 짓기(rename)`이다. 대상은 클래스, 메서드, 모든 종류의 변수다.
- 실습의 목표는 matches() 메서드의 복잡도를 줄여 코드가 무엇을 담당하는지 그 정책을 쉽게 이해하는 것이다.

```java
public boolean matches(Criteria criteria) {
    // ...
    for (Criterion criterion: criteria) {
        // ...
        boolean match = 
            criterion.getWeight() == Weight.DontCare ||
            answer.match(criterion.getAnswer());
        // ...
    }
    // ...
}
```

```java
public boolean matches(Criteria criteria) {
    // ...
    for (Criterion criterion: criteria) {
        // ...
        boolean match = matches(criterion, answer);
        // ...
    }
    // ...
}

private boolean matches(Criterion criterion, Answer answer) {
    return criterion.getWeight() == Weight.DontCare ||
        answer.match(criterion.getAnswer());
}
```

- 할당 부분을 별도의 메서드로 추출하여 복잡성을 고립시킨다.
- 조건이 답변과 어떻게 매치되는지 알고 싶다면 새로 추출된 matches() 메서드로 이동한다.
- 코드를 안전하게 옮길 수 있는 능력은 단위 테스트의 가장 중요한 이점이다.

### 메서드를 위한 더 좋은 집 찾기

- 반복문의 가독성은 좋아졌지만 새로 만든 matches() 메서드의 경우 Profile 객체와 아무런 관계가 없다.
- 오히려 Answer 클래스 혹은 Criterion 클래스와 관련 있어 보인다.
- Criterion 객체는 이미 Answer 객체를 알고 있지만 그 역은 성립하지 않기 때문에 matches() 메서드를 Criterion으로 이동한다.

```java
public class Criterion implements Scoreable {
   //... 

   public boolean matches(Answer answer) {
      return getWeight() == Weight.DontCare ||
              answer.match(getAnswer());
   }
}
```

```java
public boolean matches(Criteria criteria) {
    // ...
    for (Criterion criterion: criteria) {
        // ...
        boolean match = criterion.matches(answer);
        // ...
    }
    // ...
}
```

- answers 지역 변수에 할당하는 문장은 꽤 길고 복잡하다.
- `디메테르의 법칙(the law of demeter)`을 위반하며 깔끔하지 않다. 즉, 다른 객체로 전파되는 연쇄적인 메서드 호출을 하고 있다.

```java
Answer answer = answers.get(
               criterion.getAnswer().getQuestionText());
```

- 개선하기 위해서 answer 할당문의 우변을 새로운 메서드인 answerMatching() 메서드로 추출한다.
- 임시 변수를 사용하여 코드 의도를 명확하게 하는 것이 좋다.

```java
public boolean matches(Criteria criteria) {
    // ...
    for (Criterion criterion: criteria) {
        Answer answer = answerMatching(criterion);
        boolean match = criterion.matches(answer);
        // ...
    }
    // ...
}

private Answer answerMatching(Criterion criterion) {
    return answers.get(criterion.getAnswer().getQuestionText());
}
```


---
[Home](../README.md)
